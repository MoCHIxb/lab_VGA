module BGM_WIN (
    input clk,
    input start,
    input rstn,
    input wire [15:0] frac,
    input [2:0] speedup,
    output reg B
);
  reg [26:1] t;
  reg [26:1] total;
  reg clk_out;
  reg [10:0] state;
  reg [8:1] m;

  always @(posedge clk, negedge rstn)
    if (~rstn) total <= 3125000 * 3;
    // else if(speedup==1) total<=3125000;
    else if (speedup == 2) total <= 3125000;
    else total <= 3125000 * 3;

  always @(posedge clk, negedge rstn)
    if (~rstn) begin
      clk_out <= 0;
      t <= total;
    end else if (t == 0) begin
      clk_out <= ~clk_out;
      t <= total;
    end else begin
      t <= t - 1;
    end

  always @(posedge clk_out, negedge rstn)
    if (~rstn) state <= 0;
    else if (start) begin
      if (state != 196) state <= state + 1;
      else state <= 0;
    end

  always @(*)
    if (start)
      case (state)  //《英雄之证》
        0: m = 15;
        1: m = 10;
        2: m = 15;
        3: m = 17;
        4: m = 0;
        5: m = 10;
        6: m = 15;
        7: m = 17;
        8: m = 15;
        9: m = 10;

        10: m = 22;
        11: m = 22;
        12: m = 0;
        13: m = 20;
        14: m = 18;
        15: m = 17;
        16: m = 17;
        17: m = 13;
        18: m = 13;

        19: m = 15;
        20: m = 17;
        21: m = 18;
        22: m = 17;
        23: m = 15;
        24: m = 17;
        25: m = 13;
        26: m = 13;

        27: m = 10;
        28: m = 10;
        29: m = 10;
        30: m = 10;
        31: m = 10;
        32: m = 10;
        33: m = 0;

        34: m = 15;
        35: m = 10;
        36: m = 15;
        37: m = 17;
        38: m = 0;
        39: m = 10;
        40: m = 15;
        41: m = 17;
        42: m = 15;
        43: m = 10;

        44: m = 27;
        45: m = 27;
        46: m = 0;
        47: m = 28;
        48: m = 26;
        49: m = 24;
        50: m = 23;
        51: m = 23;
        52: m = 19;
        53: m = 19;

        54: m = 21;
        55: m = 23;
        56: m = 24;
        57: m = 23;
        58: m = 24;
        59: m = 26;
        60: m = 26;
        61: m = 31;
        62: m = 31;

        63: m = 33;
        64: m = 33;
        65: m = 33;
        66: m = 33;
        67: m = 33;
        68: m = 33;
        69: m = 0;

        70: m = 29;
        71: m = 29;
        72: m = 29;
        73: m = 28;
        74: m = 26;
        75: m = 24;
        76: m = 24;
        77: m = 26;
        78: m = 26;

        79: m = 28;
        80: m = 28;
        81: m = 23;
        82: m = 23;
        83: m = 23;
        84: m = 23;
        85: m = 23;

        86: m = 24;
        87: m = 24;
        88: m = 24;
        89: m = 23;
        90: m = 21;
        91: m = 19;
        92: m = 19;
        93: m = 21;
        94: m = 21;

        95:  m = 23;
        96:  m = 23;
        97:  m = 23;
        98:  m = 23;
        99:  m = 23;
        100: m = 23;
        101: m = 0;  //第一面谱子结束

        102: m = 21;
        103: m = 21;
        104: m = 21;
        105: m = 23;
        106: m = 24;
        107: m = 24;
        108: m = 28;
        109: m = 28;

        110: m = 31;
        111: m = 31;
        112: m = 31;
        113: m = 29;
        114: m = 28;
        115: m = 26;
        116: m = 26;
        117: m = 24;
        118: m = 24;

        119: m = 28;
        120: m = 28;
        121: m = 28;
        122: m = 28;
        123: m = 28;
        124: m = 28;
        125: m = 26;

        126: m = 28;
        127: m = 28;
        128: m = 28;
        129: m = 28;
        130: m = 28;
        131: m = 0;

        132: m = 21;
        133: m = 19;
        134: m = 21;
        135: m = 16;
        136: m = 0;
        137: m = 21;
        138: m = 0;
        139: m = 24;
        140: m = 0;

        141: m = 26;
        142: m = 24;
        143: m = 26;
        144: m = 21;
        145: m = 0;
        146: m = 0;
        147: m = 0;
        148: m = 0;

        149: m = 0;
        150: m = 0;
        151: m = 14;
        152: m = 14;
        153: m = 16;
        154: m = 16;
        155: m = 21;
        156: m = 21;

        157: m = 23;
        158: m = 23;
        159: m = 23;
        160: m = 23;
        161: m = 16;
        162: m = 16;
        163: m = 16;
        164: m = 16;

        165: m = 21;
        166: m = 19;
        167: m = 21;
        168: m = 16;
        169: m = 0;
        170: m = 21;
        171: m = 0;
        172: m = 24;
        173: m = 0;

        174: m = 26;
        175: m = 24;
        176: m = 26;
        177: m = 21;
        178: m = 0;
        179: m = 0;
        180: m = 0;
        181: m = 0;

        182: m = 21;
        183: m = 21;
        184: m = 21;
        185: m = 21;
        186: m = 24;
        187: m = 24;
        188: m = 28;
        189: m = 28;

        190: m = 31;
        191: m = 31;
        192: m = 31;
        193: m = 29;
        194: m = 28;
        195: m = 24;
        196: m = 24;

        default: m = 0;
      endcase
    else m = 0;

  reg [27:1] q;
  always @(*) begin
    case (m)
      7'd0:  q = 0;  // 0
      7'd1:  q = 28'd100000000 / 139;  // C#3/Db3
      7'd2:  q = 28'd100000000 / 147;  // D3
      7'd3:  q = 28'd100000000 / 156;  // D#3/Eb3
      7'd4:  q = 28'd100000000 / 165;  // E3
      7'd5:  q = 28'd100000000 / 175;  // F3
      7'd6:  q = 28'd100000000 / 185;  // F#3/Gb3
      7'd7:  q = 28'd100000000 / 196;  // G3
      7'd8:  q = 28'd100000000 / 208;  // G#3/Ab3
      7'd9:  q = 28'd100000000 / 220;  // A3
      7'd10: q = 28'd100000000 / 233;  // A#3/Bb3
      7'd11: q = 28'd100000000 / 247;  // B3

      7'd12: q = 28'd100000000 / 262;  // C4
      7'd13: q = 28'd100000000 / 277;  // C#4/Db4
      7'd14: q = 28'd100000000 / 294;  // D4
      7'd15: q = 28'd100000000 / 311;  // D#4/Eb4
      7'd16: q = 28'd100000000 / 330;  // E4
      7'd17: q = 28'd100000000 / 349;  // F4
      7'd18: q = 28'd100000000 / 370;  // F#4/Gb4
      7'd19: q = 28'd100000000 / 392;  // G4
      7'd20: q = 28'd100000000 / 415;  // G#4/Ab4
      7'd21: q = 28'd100000000 / 440;  // A4
      7'd22: q = 28'd100000000 / 466;  // A#4/Bb4
      7'd23: q = 28'd100000000 / 494;  // B4

      7'd24: q = 28'd100000000 / 523;  // C5
      7'd25: q = 28'd100000000 / 554;  // C#5/Db5
      7'd26: q = 28'd100000000 / 587;  // D5
      7'd27: q = 28'd100000000 / 622;  // D#5/Eb5
      7'd28: q = 28'd100000000 / 659;  // E5
      7'd29: q = 28'd100000000 / 698;  // F5
      7'd30: q = 28'd100000000 / 740;  // F#5/Gb5
      7'd31: q = 28'd100000000 / 784;  // G5
      7'd32: q = 28'd100000000 / 831;  // G#5/Ab5
      7'd33: q = 28'd100000000 / 880;  // A5
      7'd34: q = 28'd100000000 / 932;  // A#5/Bb5
      7'd35: q = 28'd100000000 / 988;  // B5

      7'd36: q = 28'd100000000 / 1047;  // C6
      7'd37: q = 28'd100000000 / 1109;  // C#6/Db6
      7'd38: q = 28'd100000000 / 1175;  // D6
      7'd39: q = 28'd100000000 / 1245;  // D#6/Eb6
      7'd40: q = 28'd100000000 / 1319;  // E6
      7'd41: q = 28'd100000000 / 1397;  // F6
      7'd42: q = 28'd100000000 / 1480;  // F#6/Gb6
      7'd43: q = 28'd100000000 / 1568;  // G6
      7'd44: q = 28'd100000000 / 1661;  // G#6/Ab6
      7'd45: q = 28'd100000000 / 1760;  // A6
      7'd46: q = 28'd100000000 / 1865;  // A#6/Bb6
      7'd47: q = 28'd100000000 / 1976;  // B6

      7'd48:   q = 28'd100000000 / 2093;  // C7
      default: q = 0;
    endcase
  end

  reg [27:1] p;
  reg [27:1] tt;
  always @(posedge clk, negedge rstn) begin
    if (~rstn) begin
      B <= 0;
      p <= 0;
    end else begin
      tt <= q;
      if (q == 0 || tt != q) begin
        if (q == 0) begin
          B <= 0;
        end
        if (tt != q) begin
          p <= 0;
        end
      end else begin
        if (p == q - 1) p <= 0;
        else p <= p + 1;
        if (p == 0) B <= 1;
        if (p == q / frac) B <= 0;  //占空比控制音量
      end
    end
  end
endmodule
