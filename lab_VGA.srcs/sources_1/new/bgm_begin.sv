module BGM_BEGIN (
    input clk,
    input start,
    input rstn,
    input wire [15:0] frac,
    input [2:0] speedup,
    output reg B
);
  reg [26:1] t;
  reg [26:1] total;
  reg clk_out;
  reg [10:0] state;
  reg [8:1] m;

  always @(posedge clk, negedge rstn)
    if (~rstn) total <= 3125000 * 6;
    // else if(speedup==1) total<=3125000;
    else if (speedup == 2) total <= 3125000;
    else total <= 3125000 * 6;

  always @(posedge clk, negedge rstn)
    if (~rstn) begin
      clk_out <= 0;
      t <= total;
    end else if (t == 0) begin
      clk_out <= ~clk_out;
      t <= total;
    end else begin
      t <= t - 1;
    end

  always @(posedge clk_out, negedge rstn)
    if (~rstn) state <= 0;
    else if (start) begin
      if (state != 140) state <= state + 1;
      else state <= 0;
    end

  always @(*)
    if (start)
      case (state)  //《Karama》
        0: m = 36;//C6
        1: m = 36;
        2: m = 36;
        3: m = 40;
        4: m = 35;
        5: m = 35;
        6: m = 35;
        7: m = 40;

        8: m = 33;
        9: m = 33;
        10: m = 36;
        11: m = 36;
        12: m = 31;
        13: m = 31;
        14: m = 29;
        15: m = 29;

        16: m = 29;
        17: m = 29;
        18: m = 29;
        19: m = 36;
        20: m = 28;
        21: m = 28;
        22: m = 31;
        23: m = 36;

        24: m = 36;
        25: m = 36;
        26: m = 33;
        27: m = 33;
        28: m = 35;
        29: m = 35;
        30: m = 35;
        31: m = 35;

        32: m = 36;
        33: m = 36;
        34: m = 36;
        35: m = 40;
        36: m = 35;
        37: m = 35;
        38: m = 35;
        39: m = 40;

        40: m = 33;
        41: m = 33;
        42: m = 36;
        43: m = 36;
        44: m = 40;
        45: m = 40;
        46: m = 40;
        47: m = 40;

        48: m = 41;
        49: m = 41;
        50: m = 36;
        51: m = 36;
        52: m = 35;
        53: m = 35;
        54: m = 40;
        55: m = 40;

        56: m = 33;
        57: m = 33;
        58: m = 33;
        59: m = 33;
        60: m = 33;
        61: m = 23;
        62: m = 24;
        63: m = 26;

        64: m = 24;
        65: m = 24;
        66: m = 24;
        67: m = 28;
        68: m = 23;
        69: m = 23;
        70: m = 23;
        71: m = 28;

        72: m = 21;
        73: m = 21;
        74: m = 24;
        75: m = 24;
        76: m = 19;
        77: m = 19;
        78: m = 16;
        79: m = 16;

        80: m = 17;
        81: m = 17;
        82: m = 17;
        83: m = 24;
        84: m = 16;
        85: m = 16;
        86: m = 16;
        87: m = 24;

        88: m = 26;
        89: m = 26;
        90: m = 21;
        91: m = 21;
        92: m = 23;
        93: m = 23;
        94: m = 23;
        95: m = 23;

        96:  m = 24;
        97:  m = 24;
        98:  m = 24;
        99:  m = 28;
        100: m = 23;
        101: m = 23;  
        102: m = 23;
        103: m = 28;

        104: m = 21;
        105: m = 21;
        106: m = 24;
        107: m = 24;
        108: m = 28;
        109: m = 29;
        110: m = 29;
        111: m = 28;

        112: m = 26;
        113: m = 26;
        114: m = 24;
        115: m = 26;
        116: m = 23;
        117: m = 23;
        118: m = 28;
        119: m = 28;

        120: m = 21;
        121: m = 21;
        122: m = 21;
        123: m = 21;
        124: m = 21;
        125: m = 21;
        126: m = 0;
        127: m = 0;

        128: m = 0;
        129: m = 0;
        130: m = 0;
        131: m = 0;
        132: m = 0;
        133: m = 0;
        134: m = 0;
        135: m = 0;
        136: m = 0;
        137: m = 0;
        138: m = 0;
        139: m = 0;
        140: m = 0;

        default: m = 0;
      endcase
    else m = 0;

  reg [27:1] q;
  always @(*) begin
    case (m)
      7'd0:  q = 0;  // 0
      7'd1:  q = 28'd100000000 / 139;  // C#3/Db3
      7'd2:  q = 28'd100000000 / 147;  // D3
      7'd3:  q = 28'd100000000 / 156;  // D#3/Eb3
      7'd4:  q = 28'd100000000 / 165;  // E3
      7'd5:  q = 28'd100000000 / 175;  // F3
      7'd6:  q = 28'd100000000 / 185;  // F#3/Gb3
      7'd7:  q = 28'd100000000 / 196;  // G3
      7'd8:  q = 28'd100000000 / 208;  // G#3/Ab3
      7'd9:  q = 28'd100000000 / 220;  // A3
      7'd10: q = 28'd100000000 / 233;  // A#3/Bb3
      7'd11: q = 28'd100000000 / 247;  // B3

      7'd12: q = 28'd100000000 / 262;  // C4
      7'd13: q = 28'd100000000 / 277;  // C#4/Db4
      7'd14: q = 28'd100000000 / 294;  // D4
      7'd15: q = 28'd100000000 / 311;  // D#4/Eb4
      7'd16: q = 28'd100000000 / 330;  // E4
      7'd17: q = 28'd100000000 / 349;  // F4
      7'd18: q = 28'd100000000 / 370;  // F#4/Gb4
      7'd19: q = 28'd100000000 / 392;  // G4
      7'd20: q = 28'd100000000 / 415;  // G#4/Ab4
      7'd21: q = 28'd100000000 / 440;  // A4
      7'd22: q = 28'd100000000 / 466;  // A#4/Bb4
      7'd23: q = 28'd100000000 / 494;  // B4

      7'd24: q = 28'd100000000 / 523;  // C5
      7'd25: q = 28'd100000000 / 554;  // C#5/Db5
      7'd26: q = 28'd100000000 / 587;  // D5
      7'd27: q = 28'd100000000 / 622;  // D#5/Eb5
      7'd28: q = 28'd100000000 / 659;  // E5
      7'd29: q = 28'd100000000 / 698;  // F5
      7'd30: q = 28'd100000000 / 740;  // F#5/Gb5
      7'd31: q = 28'd100000000 / 784;  // G5
      7'd32: q = 28'd100000000 / 831;  // G#5/Ab5
      7'd33: q = 28'd100000000 / 880;  // A5
      7'd34: q = 28'd100000000 / 932;  // A#5/Bb5
      7'd35: q = 28'd100000000 / 988;  // B5

      7'd36: q = 28'd100000000 / 1047;  // C6
      7'd37: q = 28'd100000000 / 1109;  // C#6/Db6
      7'd38: q = 28'd100000000 / 1175;  // D6
      7'd39: q = 28'd100000000 / 1245;  // D#6/Eb6
      7'd40: q = 28'd100000000 / 1319;  // E6
      7'd41: q = 28'd100000000 / 1397;  // F6
      7'd42: q = 28'd100000000 / 1480;  // F#6/Gb6
      7'd43: q = 28'd100000000 / 1568;  // G6
      7'd44: q = 28'd100000000 / 1661;  // G#6/Ab6
      7'd45: q = 28'd100000000 / 1760;  // A6
      7'd46: q = 28'd100000000 / 1865;  // A#6/Bb6
      7'd47: q = 28'd100000000 / 1976;  // B6

      7'd48:   q = 28'd100000000 / 2093;  // C7
      default: q = 0;
    endcase
  end

  reg [27:1] p;
  reg [27:1] tt;
  always @(posedge clk, negedge rstn) begin
    if (~rstn) begin
      B <= 0;
      p <= 0;
    end else begin
      tt <= q;
      if (q == 0 || tt != q) begin
        if (q == 0) begin
          B <= 0;
        end
        if (tt != q) begin
          p <= 0;
        end
      end else begin
        if (p == q - 1) p <= 0;
        else p <= p + 1;
        if (p == 0) B <= 1;
        if (p == q / frac) B <= 0;  //占空比控制音量
      end
    end
  end
endmodule
